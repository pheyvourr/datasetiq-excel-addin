<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DataSetIQ Excel Add-in Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #0f172a; }
        h2 { color: #475569; margin-top: 0; }
        button {
            background: #0f172a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1e293b; }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-left: 3px solid #0f172a;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-color: #10b981; }
        .error { border-color: #ef4444; color: #dc2626; }
        .status { display: inline-block; margin-left: 10px; }
        .status.ok { color: #10b981; }
        .status.fail { color: #ef4444; }
    </style>
</head>
<body>
    <h1>üß™ DataSetIQ Excel Add-in Test Suite</h1>
    <p>Testing all endpoints and functionality without Excel</p>

    <div class="test-section">
        <h2>1. Manifest & Icons</h2>
        <button onclick="testEndpoint('manifest', '/manifest.xml')">Test Manifest</button>
        <button onclick="testEndpoint('icon32', '/assets/icon-32.png')">Test Icon 32</button>
        <button onclick="testEndpoint('icon64', '/assets/icon-64.png')">Test Icon 64</button>
        <div id="manifest-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>2. Custom Functions Files</h2>
        <button onclick="testEndpoint('functions.js', '/functions.js')">functions.js</button>
        <button onclick="testEndpoint('functions.json', '/functions.json')">functions.json</button>
        <button onclick="testEndpoint('functions.html', '/functions.html')">functions.html</button>
        <div id="functions-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>3. Taskpane UI</h2>
        <button onclick="testEndpoint('taskpane', '/taskpane/index.html')">taskpane/index.html</button>
        <button onclick="window.open('https://plugins.datasetiq.com/taskpane/index.html', '_blank')">Open Taskpane</button>
        <div id="taskpane-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>4. API Integration Test</h2>
        <p class="muted">Note: Series endpoint requires authentication. Test verifies endpoint responds correctly.</p>
        <button onclick="testAPI()">Test FRED-GDP API</button>
        <button onclick="testAPIWithKey()">Test with API Key</button>
        <div id="api-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>5. CORS Headers</h2>
        <button onclick="testCORS()">Test CORS</button>
        <div id="cors-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>6. Search Functionality</h2>
        <button onclick="testSearch()">Test Search API</button>
        <button onclick="testSearchWithSource()">Test Source Filter</button>
        <div id="search-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>7. Browse by Source</h2>
        <button onclick="testBrowse('FRED')">Browse FRED</button>
        <button onclick="testBrowse('BLS')">Browse BLS</button>
        <button onclick="testBrowse('OECD')">Browse OECD</button>
        <div id="browse-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>8. Storage API (OfficeRuntime.storage)</h2>
        <button onclick="testStorage()">Test Storage Mock</button>
        <div id="storage-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>9. Preview Feature</h2>
        <button onclick="testPreview()">Test Series Preview</button>
        <div id="preview-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>10. Taskpane Features UI</h2>
        <button onclick="testTaskpaneFeatures()">Test UI Features</button>
        <div id="features-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>üìä Overall Status</h2>
        <div id="overall-status"></div>
    </div>

    <script>
        const BASE_URL = 'https://plugins.datasetiq.com';
        const API_URL = 'https://www.datasetiq.com/api/public/series';
        let testResults = {};

        async function testEndpoint(name, path) {
            const resultDiv = document.getElementById(name.includes('.') ? name.split('.')[0] + '-result' : name + '-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = `Testing ${path}...`;

            try {
                const response = await fetch(BASE_URL + path);
                const status = response.status;
                const statusText = status === 200 ? '‚úÖ OK' : `‚ùå Failed (${status})`;
                
                testResults[name] = status === 200;
                
                if (status === 200) {
                    const contentType = response.headers.get('content-type');
                    const size = response.headers.get('content-length') || 'unknown';
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `${statusText}\nContent-Type: ${contentType}\nSize: ${size} bytes`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `${statusText}\n${await response.text()}`;
                }
            } catch (error) {
                testResults[name] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing API without authentication...';

            try {
                // Test with a real series ID from search results
                const response = await fetch(`${API_URL}/wb%2FNE.EXP.GNFS.ZS%2FUSA/data?limit=3`);
                const status = response.status;
                
                // Unauthenticated requests get limited data (100 observations)
                if (status === 200) {
                    const data = await response.json();
                    if (data.data && Array.isArray(data.data)) {
                        testResults['api'] = true;
                        resultDiv.className = 'result success';
                        resultDiv.textContent = `‚úÖ API endpoint working!\nSeries: ${data.seriesId}\nData points: ${data.data.length}\nLatest: ${JSON.stringify(data.data[data.data.length - 1])}\nHas more: ${data.hasMore}`;
                        updateOverallStatus();
                        return;
                    }
                }
                
                // 404 means series not found or wrong endpoint
                if (status === 404) {
                    const errorData = await response.json().catch(() => null);
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå HTTP 404: Series not found or incorrect endpoint\nURL: ${response.url}\nError: ${errorData ? JSON.stringify(errorData) : 'Unknown'}`;
                    testResults['api'] = false;
                    updateOverallStatus();
                    return;
                }
                
                if (!response.ok) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Unexpected HTTP ${status}: ${response.statusText}\nURL: ${response.url}`;
                    testResults['api'] = false;
                    updateOverallStatus();
                    return;
                }
                
                const data = await response.json();
                testResults['api'] = true;
                
                if (data.error) {
                    resultDiv.className = 'result';
                    resultDiv.textContent = `‚úÖ API responding\nError Code: ${data.error.code}\nMessage: ${data.error.message}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ API working!\nLatest GDP: ${data.scalar}\nResponse: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                testResults['api'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå API Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testAPIWithKey() {
            const key = prompt('Enter your DataSetIQ API key (optional):');
            if (!key) return;

            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing API with authentication...';

            try {
                // Test data endpoint with auth (gets 1000 observations limit)
                const response = await fetch(`${API_URL}/wb%2FNE.EXP.GNFS.ZS%2FUSA/data?limit=5`, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå HTTP ${response.status}: ${response.statusText}\n${errorData ? JSON.stringify(errorData, null, 2) : ''}`;
                    return;
                }
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå ${data.error.message}\nCode: ${data.error.code}`;
                } else if (data.data && Array.isArray(data.data)) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Authenticated successfully!\nSeries: ${data.seriesId}\nData points: ${data.data.length}\nSample data:\n${JSON.stringify(data.data.slice(0, 3), null, 2)}\nHas more: ${data.hasMore}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Unexpected response format:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function testCORS() {
            const resultDiv = document.getElementById('cors-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing CORS headers...';

            try {
                const response = await fetch(`${BASE_URL}/functions.js`);
                const corsOrigin = response.headers.get('access-control-allow-origin');
                const corsMethods = response.headers.get('access-control-allow-methods');
                const corsHeaders = response.headers.get('access-control-allow-headers');

                testResults['cors'] = corsOrigin === '*';

                if (corsOrigin === '*') {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ CORS configured correctly\n` +
                        `Origin: ${corsOrigin}\n` +
                        `Methods: ${corsMethods}\n` +
                        `Headers: ${corsHeaders}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå CORS not configured\nOrigin: ${corsOrigin || 'missing'}`;
                }
            } catch (error) {
                testResults['cors'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        function updateOverallStatus() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r).length;
            const percentage = total > 0 ? Math.round((passed / total) * 100) : 0;

            const statusDiv = document.getElementById('overall-status');
            statusDiv.innerHTML = `
                <h3>Tests Passed: ${passed}/${total} (${percentage}%)</h3>
                <p>‚úÖ = Passed, ‚ùå = Failed</p>
                ${Object.entries(testResults).map(([name, result]) => 
                    `<div>${result ? '‚úÖ' : '‚ùå'} ${name}</div>`
                ).join('')}
            `;
        }

        async function testSearch() {
            const resultDiv = document.getElementById('search-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing search API...';

            try {
                const response = await fetch('https://www.datasetiq.com/api/public/search?q=GDP');
                const status = response.status;
                
                if (status !== 200 && status !== 208) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå HTTP ${status}: ${response.statusText}\nURL: ${response.url}`;
                    testResults['search'] = false;
                    updateOverallStatus();
                    return;
                }
                const data = await response.json();
                
                testResults['search'] = (status === 200 || status === 208) && Array.isArray(data);
                
                if (testResults['search']) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Search working!\nFound ${data.length} results\nSample: ${JSON.stringify(data.slice(0, 3), null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Search failed\nStatus: ${response.status}`;
                }
            } catch (error) {
                testResults['search'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testSearchWithSource() {
            const resultDiv = document.getElementById('search-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing search with source filter...';

            try {
                const response = await fetch('https://www.datasetiq.com/api/public/search?q=GDP&source=FRED');
                const status = response.status;
                
                if (status !== 200 && status !== 208) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå HTTP ${status}: ${response.statusText}`;
                    testResults['search-source'] = false;
                    updateOverallStatus();
                    return;
                }
                const data = await response.json();
                
                testResults['search-source'] = (status === 200 || status === 208) && Array.isArray(data);
                
                if (testResults['search-source']) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Source filter working!\nFound ${data.length} FRED results\nSample: ${JSON.stringify(data.slice(0, 2), null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Source filter failed\nStatus: ${response.status}`;
                }
            } catch (error) {
                testResults['search-source'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testBrowse(source) {
            const resultDiv = document.getElementById('browse-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = `Testing browse for ${source}...`;

            try {
                const response = await fetch(`https://www.datasetiq.com/api/public/search?source=${source}&limit=50`);
                const status = response.status;
                
                if (status !== 200 && status !== 208) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå HTTP ${status}: ${response.statusText}\nURL: ${response.url}`;
                    testResults[`browse-${source}`] = false;
                    updateOverallStatus();
                    return;
                }
                const data = await response.json();
                
                testResults[`browse-${source}`] = (status === 200 || status === 208) && Array.isArray(data);
                
                if (testResults[`browse-${source}`]) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Browse ${source} working!\nFound ${data.length} series\nSamples:\n${JSON.stringify(data.slice(0, 3).map(s => ({id: s.id, title: s.title})), null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Browse failed\nStatus: ${response.status}`;
                }
            } catch (error) {
                testResults[`browse-${source}`] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testStorage() {
            const resultDiv = document.getElementById('storage-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing storage mock...';

            try {
                // Mock OfficeRuntime.storage behavior
                const storage = {
                    data: {},
                    async getItem(key) { return this.data[key] || null; },
                    async setItem(key, value) { this.data[key] = value; },
                    async removeItem(key) { delete this.data[key]; }
                };

                // Test set/get
                await storage.setItem('test-key', 'test-value');
                const value = await storage.getItem('test-key');
                
                // Test favorites
                const favorites = ['FRED-GDP', 'BLS-UNRATE', 'OECD-GDP'];
                await storage.setItem('DATASETIQ_FAVORITES', JSON.stringify(favorites));
                const storedFavs = JSON.parse(await storage.getItem('DATASETIQ_FAVORITES'));
                
                // Test recent
                const recent = ['FRED-GDP', 'FRED-CPIAUCSL'];
                await storage.setItem('DATASETIQ_RECENT', JSON.stringify(recent));
                const storedRecent = JSON.parse(await storage.getItem('DATASETIQ_RECENT'));

                testResults['storage'] = value === 'test-value' && storedFavs.length === 3 && storedRecent.length === 2;
                
                if (testResults['storage']) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Storage logic verified!\nFavorites: ${storedFavs.length} items\nRecent: ${storedRecent.length} items\nSample favorites: ${JSON.stringify(storedFavs, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Storage test failed`;
                }
            } catch (error) {
                testResults['storage'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testPreview() {
            const resultDiv = document.getElementById('preview-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing preview data fetch...';

            try {
                // Fetch both latest value and metadata
                const [latestRes, metaRes] = await Promise.all([
                    fetch(`${API_URL}/FRED-GDP?mode=latest`),
                    fetch(`${API_URL}/FRED-GDP?mode=meta`)
                ]);

                const latestData = await latestRes.json();
                const metaData = await metaRes.json();

                testResults['preview'] = latestRes.status === 200 && metaRes.status === 200;

                if (testResults['preview']) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Preview data working!\n\nLatest Value: ${latestData.scalar || 'N/A'}\n\nMetadata:\n${JSON.stringify(metaData.meta, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Preview failed\nLatest status: ${latestRes.status}\nMeta status: ${metaRes.status}`;
                }
            } catch (error) {
                testResults['preview'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        async function testTaskpaneFeatures() {
            const resultDiv = document.getElementById('features-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Checking taskpane for new features...';

            try {
                const response = await fetch(`${BASE_URL}/taskpane/index.html`);
                const html = await response.text();

                // Check for feature indicators in the code
                const hasSearch = html.includes('search') || html.includes('Search');
                const hasFavorites = html.includes('favorites') || html.includes('Favorites');
                const hasRecent = html.includes('recent') || html.includes('Recent');
                const hasBrowse = html.includes('browse') || html.includes('Browse');
                const hasPreview = html.includes('preview') || html.includes('Preview');
                const hasTabs = html.includes('tab') || html.includes('Tab');

                testResults['taskpane-features'] = response.status === 200;

                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Taskpane Features Check:\n` +
                    `${hasSearch ? '‚úÖ' : '‚ùå'} Search functionality\n` +
                    `${hasFavorites ? '‚úÖ' : '‚ùå'} Favorites feature\n` +
                    `${hasRecent ? '‚úÖ' : '‚ùå'} Recent series tracking\n` +
                    `${hasBrowse ? '‚úÖ' : '‚ùå'} Browse by source\n` +
                    `${hasPreview ? '‚úÖ' : '‚ùå'} Preview modal\n` +
                    `${hasTabs ? '‚úÖ' : '‚ùå'} Tabbed interface\n\n` +
                    `Note: This checks if features are present in compiled code.\n` +
                    `Open taskpane to test interactively.`;
            } catch (error) {
                testResults['taskpane-features'] = false;
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
            updateOverallStatus();
        }

        // Auto-run basic tests on load
        window.onload = async () => {
            console.log('Starting comprehensive auto-tests...');
            await testEndpoint('manifest', '/manifest.xml');
            await testEndpoint('icon32', '/assets/icon-32.png');
            await testEndpoint('icon64', '/assets/icon-64.png');
            await testEndpoint('functions.js', '/functions.js');
            await testEndpoint('functions.json', '/functions.json');
            await testEndpoint('taskpane', '/taskpane/index.html');
            await testCORS();
            await testAPI();
            await testSearch();
            await testBrowse('FRED');
            await testStorage();
            await testPreview();
            await testTaskpaneFeatures();
            console.log('All tests completed!');
        };
    </script>
</body>
</html>
